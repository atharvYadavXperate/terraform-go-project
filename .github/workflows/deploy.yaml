name: Deploy Go Function

on:
  push:
    paths:
      - 'hello-function/**'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write   # REQUIRED for OIDC

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      TF_VAR_project_id: ${{ secrets.GCP_PROJECT }}
      TF_VAR_region: ${{ secrets.GCP_REGION }}
      TF_VAR_function_name: hello-function

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Authenticate to Google Cloud (OIDC)
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # 3️⃣ Setup gcloud (needed for terraform google provider)
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
            terraform_version: 1.6.6

      # 4️⃣ Zip the Go function
      - name: Zip Go function
        run: |
           cd hello-function/function
           zip -r ../../hello-function/function.zip .

      # 5️⃣ Terraform Init
      - name: Terraform Init
        working-directory: hello-function
        run: terraform init

      # 6️⃣ Terraform Apply
      - name: Terraform Apply
        working-directory: hello-function
        run: terraform apply -auto-approve